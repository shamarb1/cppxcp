- [For the user of VccA2lTools](#for-the-user-of-vcca2ltools)
	- [Introduction](#introduction)
	- [A2L file encoding](#a2l-file-encoding)
	- [Creator](#creator)
		- [Overview](#overview)
		- [Adding A2L information in source code comments](#adding-a2l-information-in-source-code-comments)
			- [Capabilites and syntax](#capabilites-and-syntax)
		- [Examples](#examples)
			- [Scalar instances](#scalar-instances)
			- [Struct and class instances](#struct-and-class-instances)
			- [Scalar types](#scalar-types)
			- [Enums](#enums)
			- [Structs and classes](#structs-and-classes)
		- [Limitations](#limitations)
		- [Command-line options](#command-line-options)
			- [-source-path](#-source-path)
			- [-e](#-e)
			- [-o](#-o)
			- [-measurement-memory-block](#-measurement-memory-block)
			- [-characteristic-memory-block](#-characteristic-memory-block)
			- [-mute](#-mute)
			- [-uncondensed-output](#-uncondensed-output)
			- [-explode-matrices](#-explode-matrices)
			- [-skip-address-update](#-skip-address-update)
			- [-utf-8-bom](#-utf-8-bom)
			- [-h](#-h)
			- [-v](#-v)
			- [-no-greeting](#-no-greeting)
			- [-dos-line-ending](#-dos-line-ending)
	- [Merge](#merge)
		- [Overview](#overview-1)
		- [Redefinitions of items, i.e. the same item is](#redefinitions-of-items-ie-the-same-item-is)
		- [Command-line options](#command-line-options-1)
			- [-m](#-m)
			- [-i](#-i)
			- [-o](#-o-1)
			- [-process-includes](#-process-includes)
			- [-merge-groups](#-merge-groups)
			- [-merge-function](#-merge-function)
			- [-Wno-rename](#-wno-rename)
			- [-Wno-defined-twice](#-wno-defined-twice)
			- [-Wwarning=variable-redefined](#-wwarningvariable-redefined)
			- [-uncondensed-output](#-uncondensed-output-1)
			- [-utf-8-bom](#-utf-8-bom-1)
			- [-h](#-h-1)
			- [-v](#-v-1)
			- [-no-greeting](#-no-greeting)
			- [-dos-line-ending](#-dos-line-ending)
	- [Updater](#updater)
		- [Overview](#overview-2)
		- [Command-line options](#command-line-options-2)
			- [-i](#-i-1)
			- [-o](#-o-2)
			- [-e](#-e-1)
			- [-set-readonly-memory-block](#-set-readonly-memory-block)
			- [-update-memory-segments](#-update-memory-segments)
			- [-uncondensed-output](#-uncondensed-output-2)
			- [-utf-8-bom](#-utf-8-bom-2)
			- [-h](#-h-2)
			- [-v](#-v-2)
			- [-no-greeting](#-no-greeting)
			- [-dos-line-ending](#-dos-line-ending)
	- [VccPredefDaqListCreator](#vccpredefdaqlistcreator)
		- [Overview](#overview-3)
			- [Command-line options](#command-line-options-3)
			- [-i](#-i-2)
			- [-measurement-list](#-measurement-list)
			- [-o](#-o-3)
			- [-predef-daqlists-definition](#-predef-daqlists-definition)
			- [-utf-8-bom](#-utf-8-bom-3)
			- [-h](#-h-3)
			- [-v](#-v-3)
- [For the developer of VccA2lTools](#for-the-developer-of-vcca2ltools)
	- [Dependencies and build environment](#dependencies-and-build-environment)
		- [utfcpp](#utfcpp)
		- [boost](#boost)
		- [ANTLR](#antlr)
		- [libbsd](#libbsd)
		- [Google Test](#google-test)
	- [Building](#building)
	- [Testing](#testing)
# For the user of VccA2lTools
## Introduction
VccA2lTools is a suite of four independent tools


* Creator - Creator generates A2L files for hand-written C-code with a minimum of developer
input. As much information as possible is extracted from debug information. This approach
minimizes development and maintenance effort hence enabling rapid development.

* Merge - Merge merges several A2L files into a single one. It’s a must when your software is
composed of several components. These components might be for example Simulink models,
TargetLink models, Ascet or hand-written C code. The A2L files for these components can be
generated by the tool which generates the C-code, hand-written or generated by UeAl2Creator.
Regardless of how they’re created the A2L files describing the components must be merged into
a single A2L file before they can be used with a measurement and calibration tool such as ATI
Vision, Vector CANape, ETAS INCA etc. Merge accomplishes this task smoothly.

* Updater - Every measurement and calibration tool must know the memory address of the signals
and calibration parameters. These addresses frequently change when the software is rebuilt.
Hence the A2L file which describes the software must be updated with the memory address of
each signal and calibration parameter whenever the software is rebuilt. UeAl2Updater performs
this task.

* PredefDaqListCreator - Create predefined DAQ lists defintions and insert them in an A2l.
Also write the binary definition used by our inhouse XCP slave.

## A2L file encoding
Both ANSI and UTF-8 is supported for input A2L files. The encoding will be detected by VccA2lTools, i.e.
there is no command line option for encoding. Output A2L files will be encoded in UTF-8 (default)
or UTF-8 BOM.

## Creator
### Overview
Creator generates A2L files for both hand-written and generated C/C++-code with a minimum
of developer input. The core is a unique algorithm which analyzes the build products and derives
the A2L information from this analysis. This approach, to automate the A2L creation to as far as
possible, lets developers to focus on developing applications instead of writing and maintaining
A2L information. The result is fast development and efficient software development.

Not all information can be derived from build products. The developer enters this information in
comments in the source code.

### Adding A2L information in source code comments
#### Capabilites and syntax
* A2l info is given in tags similar to javadoc. See the examples in the end of this section for an
illustration of how to write the tags. Note that the only tag which is mandory is the "a2l on".
* Both // and /**/ is supported.
* The first line with an alphanumeric character in the comment block will be interpreted as the
description of the variable/type. It wil be written as the description in the generated A2L file.
* A2l info can be given per instance and per type. Information in tags for an instance takes
precedence over information in tags for the type.
* A2l information specified for base classes are inherited by derived clases.
* C++ templates can be used. The A2L information will be the same for every instantiation of the
template.
* Individual A2L data for different elements in an array is not support. Each element in an array
will get the same properties.
* For compound types (struct, class and union) and instances thereof it is possible to specifiy a2l
properties for class members and struct fields by writing the member name after the a2l tag. For
example to turn off a2l generation for struct field x write "a2l x off" Class members and struct
fields inherits some A2L properties from the parent object.
* A2L properties on/off, type (measurement or characteristic), max_refresh, read_only and
read_write will be used for all members of compound types if they are set for set for the instance
or type.
* Note that if memory area boundaries are provided on the command line then Acam Creator can
determine whether an item is a measurement or characteristic. This can be overridde by tags in
the comments.

The table below shows the supported tags

| Tag                   | Description                                   |
| --------------------- |-----------------------------------------------|
|        a2l            | on or off. If it's not "on" the then no A2L entry will be created |
|        a2l-type       | Measurement or characteristic. Use it to override type derived from memory address or when measurements and characteristics are not placed in fixed memory regions. |
|a2l-description        | Description to write in the A2L file. |
|a2l-min                | Min value to write in the A2l file. This overrides the min value derived from datatype. |
|a2l-max                | Max value to write in the A2l file. This overrides the min value derived from datatype. |
|a2l-linearCoeff        | The created COMPU_METHOD will be of type LINEAR (default is IDENTICAL) and have COEFFS according to tag value. |
|a2l-ratFuncCoeffs      | The created COMPU_METHOD will be of type RAT_FUNC (default is IDENTICAL) and have COEFFS according to tag value. |
|a2l-displayIdentifier  | The optional A2L parameter DISPLAY_IDENTIFIER will be added to the output A2L with the identifier being the argument to a2ldisplayIdentifier. |
|a2l-format             | Format string to write in the generated A2L file. |
|a2l-max_refresh        | The created A2L object will have MAX_REFRESH with the parameters passed to @a2l-max_refresh. |
|a2l-read_only          | Marks the created CHARACTERISTIC or AXIS_PTS as READ_ONLY. |
|a2l-read_write         | Marks the created MEASUREMENT as READ_WRITE. |
|a2l-unit               | Unit to write in the generated A2L file. |

### Examples
#### Scalar instances
```C++
/**
* This first line will be the description in the A2L file.
*
* @a2l on
* @a2l-min 0
* @a2l-max 20 // Comments are supported.
*/
float32 vehicle_length;
/////////////////////////////////////////////////////////////
// This description of foobar will be in the generated A2L
//
// @a2l on
/////////////////////////////////////////////////////////////
float32 foobar;
// A description of bar which shall be or type measurement.
// @a2l on
// @a2l-type measurement
uint8 bar;
```

#### Struct and class instances
```C++
// A description of this entire struct which is ignored by
// Acam Creator since description must be given for struct fields.
//
// @a2l on
// @a2l-type measurement
// @a2l-description fieldX A description of struct field x
// @a2l-max fieldY 123.5
struct AStructType anInstanceName;
```

#### Scalar types
```C++
// Description of this type
// @a2l on
// @a2l-type measurement
// @a2l-min 0
typedef double myPositiveType;
```
Every instance of myPositiveType will be an A2L measurement with min value 0. This applies also
of myPositiveType is used in structs and classes.

#### Enums
```C++
// @a2l on
// @a2l-type measurement
enum Ape {measGorilla, measChimpanzee, measOrangutan};
// @a2l on
// @a2l-type measurement
enum class Ape {measGorilla, measChimpanzee, measOrangutan};
// @a2l on
// @a2l-type measurement
typedef enum {measGorilla, measChimpanzee, measOrangutan} Ape;
```

#### Structs and classes
A2L properites applying for alll members can be provided in a comment block before the class/
struct declaration. One can can also provide information for members here as is done with x. Tags
for members can also be written right before they are declared as is the case with y.

```C++
// @a2l on
// @a2l-type measurement
// @a2l-description x x is a nice variable
// @a2l-min x 0
class AClass
{
 public:
	int x;
	// @a2l-min 3
	// @a2l-description Hello from y
	int y;
};
```
Typedef struct is also supported, see example below.
```C++
// @a2l on
// @a2l-type measurement
// @a2l-description x x is a nice variable
// @a2l-min x 0
typedef struct
{
 int x;
 // @a2l-min 3
 // @a2l-description Hello from y
 int y;
} AStruct;
```

A2L information for types will be applied both when the type is used stand-alone and when it is
used in a class or struct. In the following example there will be a MEASUREMENT generated for
aClassInstance.p.x but a CHARACTERISTIC for aClassInstance.p.y since the default from Point is
overridden at the instance declaration.

```C++
// @a2l on
// @a2l-type measurement
struct
{
 int x;
 int y;
} Point;
class AClass
{
 public:
 Point p;
};
// @a2l-type p.y characteristic
AClass aClassInstance;
```

### Limitations
The following scenarios are not supported:
* Static class members (no A2L generated)
* Pointers (no A2L generated)
* Virtual inheritance (aka "The diamond problem")
* A class inheriting a member with the same name as a member declard in the class itself

### Command-line options
#### -source-path
File or directory to scan for measurements and characteristics. This option can be given multiple
times. If the argument is a directory the file extensions .c, .cc, .cpp, .h and .hpp will be scanned. The
search for files to scan is done recursively, i.e. also subdirectories will be scanned.
### -e
ELF file to use.
### -o
Output a2l, i.e. where to write the created a2l.
### -measurement-memory-block
Memory block for measurements. Can be given multiple times in case the ECU have measurements
in several memory blocks. The argument is a start and a stop address, i.e. 0x080000-0x0F0000.
Both hexadecimal and decimal notation is supported.
### -characteristic-memory-block
Memory block for characteristics. Can be given multiple times in case the ECU have characteristics
in several memory blocks. The argument is a start and a stop address, i.e. 0x080000-0x0F0000.
Both hexadecimal and decimal notation is supported.
### -mute
Mute output for measurements/characteristics matching one of several wildcard patterns. * matches
any character any number of times and ? matches any single character.
### -uncondensed-output
The standard output format is to keep /begin, name and description on the same line. Also the
first properties of measurements, characteristics and axispts are kept on the same line. However
some broken parsers requires name, description and properties to be on individual lines. With
uncondensed output selected
### -no-greeting
Removes a greeting and an empty line from the a2l file header
### -dos-line-ending
Saves a2l file using DOS line ending format (CRLF), otherwise UNIX format (LF) will be used

```
/begin CHARACTERISTIC dummy_array "Dummy unsigned array description."
 VAL_BLK 0x0 CREATOR_UWORD 0 COMPU_METHOD_dummy_array 0 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
becomes
```
/begin CHARACTERISTIC
 dummy_array
 "Dummy unsigned array description."
 VAL_BLK
 0x0
 CREATOR_UWORD
 0
 COMPU_METHOD_dummy_array
 0
 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
#### -explode-matrices
Create one measurement/characteristic per matrix/array index instead of creating one measurement/
characteristic describing the entire matrix/array. This is useful for example when measurement and
calibration tools doesn't support matrices.
#### -skip-address-update
Will not update addresses for newly created A2L objects. This is useful to optimize very large
builds which uses Updater.
#### -utf-8-bom
According to the Unicode standard, the BOM for files encoded in UTF-8 is not recommended.
However some programs, for example Vector CANApe, requires it in order to correctly interpret
non-english characters such as Swedish or Chinese. Try adding this option if non-english characters
doesn't work properly in a tool which reads a file written by Acam.
#### -h
Print extensive help including invocation examples and exit.
#### -v
Print version information and exit.


## Merge
### Overview
Merge merges several a2l files into one. One of the files is the master one. The interface definitions,
byte ordering etc. from this master a2l will be used in the output file. Interface information, byte
ordering etc. in remaining a2l files to merge is ignored.

### Redefinitions of items, i.e. the same item is
If a measurement, characteristic, or axis is defined in several input a2ls then the merge is aborted
with an error message. The merge is considered failed.

The action when encountering two groups or functions with identical name depends on the
command line options -merge-functions and -merge-groups respectively. Default is to rename one
of the functions/groups during merge to avoid name clash. A warning message is issued in this case.
The merge is considered successful. However if the command line option -merge-functions is given
the the function content will be merged. Pass -merge-groups to merge group content.

If a compu method, record layout etc. is defined in several input a2ls then one of them will be
renamed to avoid name clashes. A warning message is issued in this case. The merge is considered
successful.

If a function is defined in several input a2ls the default action is to rename one of them to avoid
name clashes. A warning message is issued in this case. The merge is considered successful.
However if the command line option -merge-functions was given then function contents will be
merged. This merge is considered successful.
### Command-line options
#### -m
Master a2l. Interface information, a2ml etc. will be taken from this a2l. This argument is
compulsory.
#### -i
Additional (except master) a2l files to merge. This argument is compulsory and can be given
multiple times to merge several files.
#### -o
Output a2l, i.e. where to write the merged a2l.
#### -process-includes
process "/include" statements in input files. Default is to not process includes.
#### -merge-groups
Merge group contents if a function is defined more than once in the a2ls to merge.
#### -merge-function
Merge function contents if a function is defined more than once in the a2ls to merge.
#### -Wno-rename
Do not issue warning when renaming items to avoid name clash.
#### -Wno-defined-twice
Default is to issue a warning if a MEASUREMENT/CHARACTERISTIC/AXIS_PTS is defined
twice with identical definition. This option silences this warning.
#### -Wwarning=variable-redefined
Default is to abort with error if a MEASUREMENT/CHARACTERISTIC/AXIS_PTS is redefined,
i.e. two definitions with different properties such as for example datatype is found in the input. This
option turns the error into a warning. Note that the redefined variable will not be in the output A2L
because different definitions is an indication of an error which might have serious consequences.
For example a too large datatype of a characteristic could cause memory overwrite.
#### -uncondensed-output
The standard output format is to keep /begin, name and description on the same line. Also the
first properties of measurements, characteristics and axispts are kept on the same line. However
some broken parsers requires name, description and properties to be on individual lines. With
uncondensed output selected
#### -no-greeting
Removes a greeting and an empty line from the a2l file header
#### -dos-line-ending
Saves a2l file using DOS line ending format (CRLF), otherwise UNIX format (LF) will be used
```
/begin CHARACTERISTIC dummy_array "Dummy unsigned array description."
 VAL_BLK 0x0 CREATOR_UWORD 0 COMPU_METHOD_dummy_array 0 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
becomes
```
/begin CHARACTERISTIC
 dummy_array
 "Dummy unsigned array description."
 VAL_BLK
 0x0
 CREATOR_UWORD
 0
 COMPU_METHOD_dummy_array
 0
 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
#### -utf-8-bom
According to the Unicode standard, the BOM for files encoded in UTF-8 is not recommended.
However some programs, for example Vector CANApe, requires it in order to correctly interpret
non-english characters such as Swedish or Chinese. Try adding this option if non-english characters
doesn't work properly in a tool which reads a file written by Acam.
#### -h
Print extensive help including invocation examples and exit.
#### -v
Print version information and exit.

## Updater
### Overview
Updater updates the addresses of measurements, characteristics and memory segment from addresses found in the
symbol table of and ELF file and DWARF debugging information from the same ELF file. The
debug information is needed to calculate array index offsets and the address of struct fields. The
following expressions are supported:
• foo - Plain variable or constant
• foo[x] - An item in an array
• foo.bar - Struct field
• foo[x].bar[y].foo - Any combination of array indexes and struct fields
### Command-line options
#### -i
A2l which addresses shall be updated.
#### -o
Output a2l, i.e. where to write the merged a2l.
#### -e
ELF file to take address information from.
#### -set-readonly-memory-block
Updater can optionally set all characteristics and axispts in a memory are to readonly. This feature is
useful for example when safety-related characteristics shall be protected.
#### -update-memory-segments
Updating address and size of MEMORY_SEGMENT is turned off by default. This flag enables the functionality. For each
MEMORY_SEGMENT found in the A2l Updater tries to find the address and size from the ELF information. It searches the ELF for
sections with name matching the name or description of the MEMORY_SEGMENT in the A2l. Description of MEMORY_SEGMENT is matched
against section name because sections in ELF quite often starts with a dot, for example .text, and item names in A2l cannot
start with a dot. Hence matching name only would make it impossible to update MEMORY_SEGMENT which corresponds to an ELF section
which name starts with dot.

#### -uncondensed-output
The standard output format is to keep /begin, name and description on the same line. Also the
first properties of measurements, characteristics and axispts are kept on the same line. However
some broken parsers requires name, description and properties to be on individual lines. With
uncondensed output selected
#### -no-greeting
Removes a greeting and an empty line from the a2l file header
#### -dos-line-ending
Saves a2l file using DOS line ending format (CRLF), otherwise UNIX format (LF) will be used
```
/begin CHARACTERISTIC dummy_array "Dummy unsigned array description."
 VAL_BLK 0x0 CREATOR_UWORD 0 COMPU_METHOD_dummy_array 0 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
becomes
```
/begin CHARACTERISTIC
 dummy_array
 "Dummy unsigned array description."
 VAL_BLK
 0x0
 CREATOR_UWORD
 0
 COMPU_METHOD_dummy_array
 0
 100
 MATRIX_DIM 4 1 1
/end CHARACTERISTIC
```
#### -utf-8-bom
According to the Unicode standard, the BOM for files encoded in UTF-8 is not recommended.
However some programs, for example Vector CANApe, requires it in order to correctly interpret
non-english characters such as Swedish or Chinese. Try adding this option if non-english characters
doesn't work properly in a tool which reads a file written by Acam.
#### -h
Print extensive help including invocation examples and exit.
#### -v
Print version information and exit.

## VccPredefDaqListCreator
### Overview
When using predefined DAQ lists their definition must be in the A2L file and in the XCP slave. This tool updates an A2L file with
definitions for predefined daq list and creates the definition file needed for the VDD XCP slave. The latter file has a proprietary binary
format. Input is the A2L file to update and one text file per perdefined DAQ list to create. These text files contain the names of
the signals to put in the predefined DAQ lists. Separator char can be space or newline.

#### Command-line options
#### -i
A2L file to add predefined DAQ list definitions to. Note that it's assumed that the first four properties after /begin DAQ is on their
own line with no blank lines allowed. This is a restriction to make the update process simpler (no need for a proper parser).
#### -measurement-list
Text file with a list of measurements to put in a DAQ list. Names shall be separated with whitespace or newline. This argument can be
given multiple times. DAQ list 0 will be created from first file, DAQ list 1 from second etc.
#### -o
Output A2l, i.e. where to write the new A2L with predefined DAQ lists inserted.

#### -predef-daqlists-definition
Where to write the binary DAQ list definition to be used by the VDD XCP slave.
#### -utf-8-bom
According to the Unicode standard, the BOM for files encoded in UTF-8 is not recommended.
However some programs, for example Vector CANApe, requires it in order to correctly interpret
non-english characters such as Swedish or Chinese. Try adding this option if non-english characters
doesn't work properly in a tool which reads a file written by Acam.
#### -h
Print extensive help including invocation examples and exit.
#### -v
Print version information and exit.

# For the developer of VccA2lTools
## Dependencies and build environment
The following external source code packages are used.
### utfcpp
Exists as Ubuntu package, just install with "sudo apt-get install libutfcpp-dev"
### boost
Some parts of boost are header-only and some are libraries. The header-only parts and regex is neede. Install with "sudo apt-get install libboost-dev;sudo apt-get install libboost-regex-dev"
### ANTLR
This do exist as an ubuntu package but for Ubuntu 20.04 (which was used for development of VccA2lTools) only in version
4.7.2. This version of ANTLR produces very slow code for C++. Hence we use 4.8 which we build ourselves. The source
code for ANTLR 4.8 is on submodules/antlr/antlr4-cpp-runtime-4.8-source. To build it do
1. sudo apt-get install uuid-dev
1. mkdir build && mkdir run && cd build
1. cmake .. -DANTLR_JAR_LOCATION=/home/owolgast/xcp/VccA2lTools/submodules/antlr/antlr-4.8-complete.jar  (with path adjusted)
1. make

### libbsd
Exists as Ubuntu package, just install with "sudo apt-get install libbsd-dev"
### Google Test
The tests uses Google Test framework. Exists as Ubuntu package, just install with "sudo apt-get install libgtest-dev"

## Building
mkdir build;cd build;cmake ..;make
The files to distribute are put in the "dist" folder.

## Testing
make test
